name: Build Android

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'
      build_number:
        description: 'Build number'
        required: false
        default: '1'

jobs:
  build:
    name: Build Android AAB
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        run: flutter pub get

      - name: Create keystore directory
        run: mkdir -p android/app/keys

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âŒ ANDROID_KEYSTORE_BASE64 secret not set"
            echo "Please add the keystore as a Base64-encoded secret"
            exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/keys/upload-keystore.jks
          echo "âœ… Keystore decoded successfully"

      - name: Create key.properties
        env:
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          cat > android/key.properties << EOF
          storePassword=$STORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=keys/upload-keystore.jks
          EOF
          echo "âœ… key.properties created"

      - name: Update version (if manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"

          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml

          # Update android/app/build.gradle
          sed -i "s/versionCode .*/versionCode $BUILD_NUMBER/" android/app/build.gradle
          sed -i "s/versionName .*/versionName \"$VERSION\"/" android/app/build.gradle

          echo "âœ… Version updated to $VERSION+$BUILD_NUMBER"

      - name: Build Android App Bundle
        run: |
          flutter build appbundle --release \
            --build-name="${{ github.event.inputs.version || '1.0.0' }}" \
            --build-number="${{ github.event.inputs.build_number || '1' }}"

      - name: Verify AAB exists
        run: |
          if [ ! -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âŒ AAB file not found"
            exit 1
          fi
          echo "âœ… AAB file created successfully"
          ls -lh build/app/outputs/bundle/release/app-release.aab

      - name: Get AAB info
        run: |
          AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
          echo "ðŸ“¦ AAB size: $AAB_SIZE"
          echo "aab_size=$AAB_SIZE" >> $GITHUB_ENV

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ github.event.inputs.version || 'latest' }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
          if-no-files-found: error

      - name: Upload build mapping (ProGuard)
        uses: actions/upload-artifact@v4
        with:
          name: mapping-${{ github.event.inputs.version || 'latest' }}
          path: build/app/outputs/mapping/release/
          retention-days: 90
          if-no-files-found: warn

      - name: Post build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– Android Build Complete

          ### Build Information
          - **Version:** ${{ github.event.inputs.version || '1.0.0' }}
          - **Build Number:** ${{ github.event.inputs.build_number || '1' }}
          - **AAB Size:** ${{ env.aab_size }}
          - **Build Type:** Release (signed)

          ### Artifacts
          - âœ… App Bundle (AAB) uploaded
          - âœ… ProGuard mapping uploaded

          ### Next Steps
          1. Download AAB artifact from this workflow run
          2. Test AAB on physical devices
          3. Upload to Google Play Console for review

          **Download AAB:** Click "Artifacts" section above
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f android/key.properties
          rm -f android/app/keys/upload-keystore.jks
          echo "âœ… Cleaned up sensitive files"
