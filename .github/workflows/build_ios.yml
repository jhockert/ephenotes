name: Build iOS

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'
      build_number:
        description: 'Build number'
        required: false
        default: '1'

jobs:
  build:
    name: Build iOS IPA
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install
          cd ..

      - name: Import Code Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$CERTIFICATE_BASE64" ]; then
            echo "âŒ IOS_CERTIFICATE_BASE64 secret not set"
            exit 1
          fi

          # Decode certificate
          echo "$CERTIFICATE_BASE64" | base64 -d > certificate.p12

          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain

          # Import certificate
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          # Allow codesign to use the keychain
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "" \
            build.keychain

          echo "âœ… Certificate imported successfully"

      - name: Import Provisioning Profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          if [ -z "$PROVISIONING_PROFILE_BASE64" ]; then
            echo "âŒ IOS_PROVISIONING_PROFILE_BASE64 secret not set"
            exit 1
          fi

          # Decode provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

          echo "âœ… Provisioning profile imported successfully"

      - name: Update version (if manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"

          # Update pubspec.yaml
          sed -i '' "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml

          # Update Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" ios/Runner/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" ios/Runner/Info.plist

          echo "âœ… Version updated to $VERSION+$BUILD_NUMBER"

      - name: Build iOS app
        env:
          TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          flutter build ios --release --no-codesign

      - name: Create ExportOptions.plist
        env:
          TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          cat > ios/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$TEAM_ID</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          echo "âœ… ExportOptions.plist created"

      - name: Archive iOS app
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
                     -scheme Runner \
                     -configuration Release \
                     -archivePath build/Runner.xcarchive \
                     archive \
                     CODE_SIGN_IDENTITY="Apple Distribution" \
                     PROVISIONING_PROFILE_SPECIFIER="ephenotes AppStore"

          echo "âœ… iOS app archived successfully"

      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
                     -archivePath build/Runner.xcarchive \
                     -exportPath build/Release-iphoneos \
                     -exportOptionsPlist ExportOptions.plist \
                     -allowProvisioningUpdates

          echo "âœ… IPA exported successfully"

      - name: Verify IPA exists
        run: |
          if [ ! -f "ios/build/Release-iphoneos/Runner.ipa" ]; then
            echo "âŒ IPA file not found"
            exit 1
          fi
          echo "âœ… IPA file created successfully"
          ls -lh ios/build/Release-iphoneos/Runner.ipa

      - name: Get IPA info
        run: |
          IPA_SIZE=$(du -h ios/build/Release-iphoneos/Runner.ipa | cut -f1)
          echo "ðŸ“¦ IPA size: $IPA_SIZE"
          echo "ipa_size=$IPA_SIZE" >> $GITHUB_ENV

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-${{ github.event.inputs.version || 'latest' }}
          path: ios/build/Release-iphoneos/Runner.ipa
          retention-days: 30
          if-no-files-found: error

      - name: Upload dSYM symbols
        uses: actions/upload-artifact@v4
        with:
          name: dsym-${{ github.event.inputs.version || 'latest' }}
          path: ios/build/Runner.xcarchive/dSYMs/
          retention-days: 90
          if-no-files-found: warn

      - name: Post build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ iOS Build Complete

          ### Build Information
          - **Version:** ${{ github.event.inputs.version || '1.0.0' }}
          - **Build Number:** ${{ github.event.inputs.build_number || '1' }}
          - **IPA Size:** ${{ env.ipa_size }}
          - **Build Type:** Release (signed for App Store)

          ### Artifacts
          - âœ… IPA uploaded
          - âœ… dSYM symbols uploaded

          ### Next Steps
          1. Download IPA artifact from this workflow run
          2. Test IPA on physical iOS devices
          3. Upload to App Store Connect via Transporter or Fastlane

          **Download IPA:** Click "Artifacts" section above

          **Upload to App Store Connect:**
          \`\`\`bash
          xcrun altool --upload-app --type ios --file Runner.ipa \\
            --username your-apple-id@email.com \\
            --password "app-specific-password"
          \`\`\`
          EOF

      - name: Cleanup
        if: always()
        run: |
          # Delete keychain
          security delete-keychain build.keychain || true

          # Remove certificate and provisioning profile
          rm -f certificate.p12
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

          # Clean build artifacts
          rm -rf ios/build

          echo "âœ… Cleaned up sensitive files"
