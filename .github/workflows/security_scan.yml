name: Security Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter dependency audit
        run: |
          echo "## ðŸ” Dependency Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for outdated packages
          flutter pub outdated --json > outdated.json || true
          
          # Check for known vulnerabilities (if available)
          if command -v dart &> /dev/null; then
            echo "### Checking for known vulnerabilities..." >> $GITHUB_STEP_SUMMARY
            dart pub audit --json > audit.json 2>&1 || true
            
            if [ -f audit.json ]; then
              echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
              cat audit.json >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependency scan complete" >> $GITHUB_STEP_SUMMARY

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            outdated.json
            audit.json
          retention-days: 30
          if-no-files-found: ignore

  code-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        run: |
          echo "## ðŸ” Static Code Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          flutter analyze > analyze_output.txt 2>&1 || true
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat analyze_output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Check for security-related issues
          if grep -i "security\|vulnerability\|unsafe" analyze_output.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Potential security issues found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… No security issues detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for hardcoded secrets
        run: |
          echo "## ðŸ” Secrets Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for common secret patterns
          SECRET_PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "private[_-]?key\s*=\s*['\"][^'\"]+['\"]"
          )
          
          FOUND_SECRETS=false
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -rniE "$pattern" lib/ test/ --exclude-dir=.git --exclude="*.md" 2>/dev/null; then
              FOUND_SECRETS=true
              echo "âš ï¸ Potential hardcoded secret found: $pattern" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Hardcoded secrets detected! Please remove them." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for insecure dependencies
        run: |
          echo "## ðŸ“¦ Dependency Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check pubspec.yaml for known insecure packages
          INSECURE_PACKAGES=(
            "http:0.12"  # Old version with security issues
          )
          
          FOUND_INSECURE=false
          
          for package in "${INSECURE_PACKAGES[@]}"; do
            if grep -q "$package" pubspec.yaml; then
              FOUND_INSECURE=true
              echo "âš ï¸ Insecure package version: $package" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FOUND_INSECURE" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Insecure dependencies detected!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No known insecure dependencies" >> $GITHUB_STEP_SUMMARY
          fi

  android-security:
    name: Android Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Check Android manifest permissions
        run: |
          echo "## ðŸ¤– Android Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          if [ ! -f "$MANIFEST" ]; then
            echo "âš ï¸ AndroidManifest.xml not found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "### Permissions Declared:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`xml" >> $GITHUB_STEP_SUMMARY
          grep "uses-permission" "$MANIFEST" || echo "No permissions declared" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Check for dangerous permissions
          DANGEROUS_PERMS=(
            "READ_CONTACTS"
            "READ_SMS"
            "CAMERA"
            "RECORD_AUDIO"
            "ACCESS_FINE_LOCATION"
            "READ_PHONE_STATE"
          )
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dangerous Permissions Check:" >> $GITHUB_STEP_SUMMARY
          
          FOUND_DANGEROUS=false
          for perm in "${DANGEROUS_PERMS[@]}"; do
            if grep -q "$perm" "$MANIFEST"; then
              FOUND_DANGEROUS=true
              echo "âš ï¸ Dangerous permission: $perm" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FOUND_DANGEROUS" = false ]; then
            echo "âœ… No dangerous permissions detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for debuggable flag
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          if grep -q 'android:debuggable="true"' "$MANIFEST"; then
            echo "âŒ Debuggable flag is set to true in manifest!" >> $GITHUB_STEP_SUMMARY
            echo "This is a security risk for production builds." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Debuggable flag not set (good for production)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check ProGuard configuration
        run: |
          PROGUARD_FILE="android/app/proguard-rules.pro"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ProGuard Configuration:" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$PROGUARD_FILE" ]; then
            echo "âœ… ProGuard rules file exists" >> $GITHUB_STEP_SUMMARY
            
            # Check for common security rules
            if grep -q "keepattributes" "$PROGUARD_FILE"; then
              echo "âœ… Keep attributes configured" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Consider adding keep attributes for better security" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ ProGuard rules file not found" >> $GITHUB_STEP_SUMMARY
          fi

  ios-security:
    name: iOS Security Scan
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check iOS Info.plist security settings
        run: |
          echo "## ðŸŽ iOS Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PLIST="ios/Runner/Info.plist"
          
          if [ ! -f "$PLIST" ]; then
            echo "âš ï¸ Info.plist not found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "### App Transport Security:" >> $GITHUB_STEP_SUMMARY
          
          # Check for ATS exceptions
          if /usr/libexec/PlistBuddy -c "Print :NSAppTransportSecurity:NSAllowsArbitraryLoads" "$PLIST" 2>/dev/null | grep -q "true"; then
            echo "âš ï¸ NSAllowsArbitraryLoads is enabled (allows insecure HTTP)" >> $GITHUB_STEP_SUMMARY
            echo "Consider using HTTPS only or specific exceptions" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… App Transport Security properly configured" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Privacy Permissions:" >> $GITHUB_STEP_SUMMARY
          
          # Check for privacy-sensitive permissions
          PRIVACY_KEYS=(
            "NSCameraUsageDescription"
            "NSMicrophoneUsageDescription"
            "NSLocationWhenInUseUsageDescription"
            "NSLocationAlwaysUsageDescription"
            "NSPhotoLibraryUsageDescription"
            "NSContactsUsageDescription"
          )
          
          FOUND_PRIVACY=false
          for key in "${PRIVACY_KEYS[@]}"; do
            if /usr/libexec/PlistBuddy -c "Print :$key" "$PLIST" 2>/dev/null >/dev/null; then
              FOUND_PRIVACY=true
              echo "â„¹ï¸ Privacy permission: $key" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FOUND_PRIVACY" = false ]; then
            echo "âœ… No privacy-sensitive permissions requested" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for hardcoded URLs
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Hardcoded URLs Check:" >> $GITHUB_STEP_SUMMARY
          
          # Check for hardcoded URLs in Swift files
          if find ios/Runner -name "*.swift" -exec grep -H "http://" {} \; 2>/dev/null | grep -v "localhost"; then
            echo "âš ï¸ Hardcoded HTTP URLs found in Swift files" >> $GITHUB_STEP_SUMMARY
            echo "Consider using HTTPS or configuration files" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No hardcoded HTTP URLs found" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Security Scan Summary
    needs: [dependency-scan, code-scan, android-security, ios-security]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ”’ Security Scan Complete
          
          ## Scan Results
          
          | Scan Type | Status |
          |-----------|--------|
          | Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | Code Scan | ${{ needs.code-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | Android Security | ${{ needs.android-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | iOS Security | ${{ needs.ios-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          
          ## Recommendations
          
          - Keep dependencies up to date
          - Never commit secrets or API keys
          - Use HTTPS for all network requests
          - Minimize requested permissions
          - Enable ProGuard/R8 for Android releases
          - Review security scan results regularly
          
          ---
          
          **Last Scan:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Check overall status
        run: |
          if [[ "${{ needs.dependency-scan.result }}" != "success" ]] || \
             [[ "${{ needs.code-scan.result }}" != "success" ]] || \
             [[ "${{ needs.android-security.result }}" != "success" ]] || \
             [[ "${{ needs.ios-security.result }}" != "success" ]]; then
            echo "âŒ Security scan failed!"
            exit 1
          else
            echo "âœ… All security scans passed!"
          fi
