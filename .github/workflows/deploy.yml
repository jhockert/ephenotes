name: Deploy to App Stores

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        type: choice
        options:
          - testflight
          - playstore-internal
          - playstore-beta
          - appstore
          - playstore-production
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
      build_number:
        description: 'Build number'
        required: true
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: 'Bug fixes and performance improvements'

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      is_ios: ${{ steps.check.outputs.is_ios }}
      is_android: ${{ steps.check.outputs.is_android }}

    steps:
      - name: Check deployment target
        id: check
        run: |
          TARGET="${{ github.event.inputs.target }}"
          echo "Deployment target: $TARGET"

          if [[ "$TARGET" == "testflight" || "$TARGET" == "appstore" ]]; then
            echo "is_ios=true" >> $GITHUB_OUTPUT
            echo "is_android=false" >> $GITHUB_OUTPUT
            echo "âœ… iOS deployment"
          elif [[ "$TARGET" == "playstore"* ]]; then
            echo "is_ios=false" >> $GITHUB_OUTPUT
            echo "is_android=true" >> $GITHUB_OUTPUT
            echo "âœ… Android deployment"
          else
            echo "âŒ Invalid deployment target"
            exit 1
          fi

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi
          echo "âœ… Version format is valid"

      - name: Post deployment plan
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Deployment Plan

          ### Target
          - **Platform:** ${{ github.event.inputs.target }}
          - **Version:** ${{ github.event.inputs.version }}
          - **Build:** ${{ github.event.inputs.build_number }}

          ### Release Notes
          ${{ github.event.inputs.release_notes }}

          ---
          Proceeding with deployment...
          EOF

  deploy-ios:
    name: Deploy to iOS
    needs: validate
    if: needs.validate.outputs.is_ios == 'true'
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Fastlane
        run: |
          # Install Fastlane
          sudo gem install fastlane -NV
          
          # Verify installation
          fastlane --version
          
          echo "âœ… Fastlane installed"

      - name: Setup signing
        env:
          CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Decode certificate
          echo "$CERTIFICATE_BASE64" | base64 -d > certificate.p12
          
          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          
          # Import certificate
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "" \
            build.keychain
          
          # Import provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          
          echo "âœ… Signing configured"

      - name: Create App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          if [ -z "$API_KEY_BASE64" ]; then
            echo "âš ï¸ APP_STORE_CONNECT_API_KEY_BASE64 not set"
            echo "Will attempt to use alternative authentication"
          else
            # Create AuthKey file
            mkdir -p ~/.appstoreconnect/private_keys
            echo "$API_KEY_BASE64" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8
            
            # Export for Fastlane
            echo "APP_STORE_CONNECT_API_KEY_CONTENT=$API_KEY_BASE64" >> $GITHUB_ENV
            echo "APP_STORE_CONNECT_API_KEY_ID=$API_KEY_ID" >> $GITHUB_ENV
            echo "APP_STORE_CONNECT_ISSUER_ID=$ISSUER_ID" >> $GITHUB_ENV
            
            echo "âœ… App Store Connect API key configured"
          fi

      - name: Update version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          
          # Update pubspec.yaml
          sed -i '' "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
          
          # Update Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" ios/Runner/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" ios/Runner/Info.plist
          
          echo "âœ… Version updated to $VERSION+$BUILD_NUMBER"

      - name: Generate release notes
        run: |
          NOTES="${{ github.event.inputs.release_notes }}"
          
          # Save release notes for Fastlane
          echo "$NOTES" > ios/fastlane/release_notes.txt
          
          echo "âœ… Release notes prepared"

      - name: Build and Deploy to TestFlight
        if: github.event.inputs.target == 'testflight'
        env:
          TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          cd ios
          fastlane deploy_beta
          
          echo "âœ… Deployed to TestFlight"

      - name: Build and Deploy to App Store
        if: github.event.inputs.target == 'appstore'
        env:
          TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          cd ios
          fastlane deploy_release
          
          echo "âœ… Deployed to App Store (pending review)"

      - name: Post iOS deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ iOS Deployment Complete
          
          ### Target: ${{ github.event.inputs.target }}
          - **Status:** âœ… Deployed successfully
          - **Version:** ${{ github.event.inputs.version }}
          - **Build:** ${{ github.event.inputs.build_number }}
          
          ### Release Notes
          ${{ github.event.inputs.release_notes }}
          
          ### Next Steps
          ${{ github.event.inputs.target == 'testflight' && '1. TestFlight build will be available in ~10-15 minutes
          2. Add testers in App Store Connect
          3. Notify testers via email
          4. Monitor crash reports and feedback' || '1. Build submitted for App Store review
          2. Review typically takes 24-48 hours
          3. Monitor review status in App Store Connect
          4. Respond to any review feedback promptly' }}
          
          ### Links
          - [App Store Connect](https://appstoreconnect.apple.com/)
          - [TestFlight](https://appstoreconnect.apple.com/apps/${{ secrets.IOS_APP_ID }}/testflight)
          EOF

      - name: Cleanup
        if: always()
        run: |
          # Delete keychain
          security delete-keychain build.keychain || true
          
          # Remove certificate and provisioning profile
          rm -f certificate.p12
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          rm -f ios/fastlane/release_notes.txt
          
          echo "âœ… Cleaned up sensitive files"

  deploy-android:
    name: Deploy to Android
    needs: validate
    if: needs.validate.outputs.is_android == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Fastlane
        run: |
          # Install Fastlane
          sudo gem install fastlane -NV
          
          # Verify installation
          fastlane --version
          
          echo "âœ… Fastlane installed"

      - name: Create Google Play Service Account
        env:
          SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -z "$SERVICE_ACCOUNT_JSON_BASE64" ]; then
            echo "âŒ GOOGLE_PLAY_SERVICE_ACCOUNT_JSON not set"
            echo "Cannot proceed with automated deployment"
            exit 1
          fi
          
          echo "$SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > android/service-account.json
          echo "âœ… Service account configured"

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/app/keys
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/keys/upload-keystore.jks
          echo "âœ… Keystore configured"

      - name: Create key.properties
        env:
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          cat > android/key.properties << EOF
          storePassword=$STORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=keys/upload-keystore.jks
          EOF
          echo "âœ… key.properties created"

      - name: Update version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          
          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
          
          echo "âœ… Version updated to $VERSION+$BUILD_NUMBER"

      - name: Generate release notes
        run: |
          NOTES="${{ github.event.inputs.release_notes }}"
          
          # Save release notes for Play Console
          mkdir -p android/fastlane/metadata/android/en-US/changelogs
          echo "$NOTES" > "android/fastlane/metadata/android/en-US/changelogs/${{ github.event.inputs.build_number }}.txt"
          
          echo "âœ… Release notes prepared"

      - name: Build AAB
        run: |
          flutter build appbundle --release \
            --build-name="${{ github.event.inputs.version }}" \
            --build-number="${{ github.event.inputs.build_number }}"
          
          echo "âœ… AAB built successfully"

      - name: Deploy to Play Console Internal Testing
        if: github.event.inputs.target == 'playstore-internal'
        run: |
          cd android
          fastlane internal
          
          echo "âœ… Deployed to Internal Testing"

      - name: Deploy to Play Console Beta
        if: github.event.inputs.target == 'playstore-beta'
        run: |
          cd android
          fastlane beta
          
          echo "âœ… Deployed to Beta (Open Testing)"

      - name: Deploy to Play Console Production
        if: github.event.inputs.target == 'playstore-production'
        run: |
          cd android
          fastlane production
          
          echo "âœ… Deployed to Production"

      - name: Post Android deployment summary
        run: |
          TARGET="${{ github.event.inputs.target }}"
          TRACK="Internal Testing"
          
          if [ "$TARGET" = "playstore-beta" ]; then
            TRACK="Beta (Open Testing)"
          elif [ "$TARGET" = "playstore-production" ]; then
            TRACK="Production"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– Android Deployment Complete
          
          ### Target: $TRACK
          - **Status:** âœ… Deployed successfully
          - **Version:** ${{ github.event.inputs.version }}
          - **Build:** ${{ github.event.inputs.build_number }}
          
          ### Release Notes
          ${{ github.event.inputs.release_notes }}
          
          ### Next Steps
          1. Build will be available in Play Console in ~5-10 minutes
          2. Review the release in Play Console
          3. ${{ github.event.inputs.target == 'playstore-internal' && 'Add internal testers and share the link' || github.event.inputs.target == 'playstore-beta' && 'Monitor beta feedback and crash reports' || 'Monitor production rollout and user feedback' }}
          4. Check crash reports and ANRs
          
          ### Links
          - [Google Play Console](https://play.google.com/console)
          - [Release Dashboard](https://play.google.com/console/u/0/developers/${{ secrets.GOOGLE_PLAY_DEVELOPER_ID }}/app/${{ secrets.GOOGLE_PLAY_APP_ID }}/releases/overview)
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f android/service-account.json
          rm -f android/key.properties
          rm -f android/app/keys/upload-keystore.jks
          rm -rf android/fastlane/metadata/android/en-US/changelogs
          echo "âœ… Cleaned up sensitive files"

  notify:
    name: Send Notification
    needs: [deploy-ios, deploy-android]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [[ "${{ needs.deploy-ios.result }}" == "success" || "${{ needs.deploy-android.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "${{ steps.status.outputs.emoji }} Deployment to ${{ github.event.inputs.target }} ${{ steps.status.outputs.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ephenotes Deployment*\n\n*Target:* ${{ github.event.inputs.target }}\n*Version:* ${{ github.event.inputs.version }}\n*Status:* ${{ steps.status.outputs.status }}"
                  }
                }
              ]
            }'
        continue-on-error: true

      - name: Post final summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${{ steps.status.outputs.emoji }} Deployment Complete

          **Target:** ${{ github.event.inputs.target }}
          **Version:** ${{ github.event.inputs.version }}
          **Build:** ${{ github.event.inputs.build_number }}
          **Status:** ${{ steps.status.outputs.status }}

          ---

          ### What's Next?

          1. Monitor crash reports and user feedback
          2. Track installation metrics
          3. Respond to user reviews
          4. Plan next release

          **App Store Links:**
          - iOS: https://apps.apple.com/app/ephenotes/idXXXXXXXXX
          - Android: https://play.google.com/store/apps/details?id=com.ephenotes.app
          EOF
